"use strict";var $=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var H=(i,t)=>{for(var a in t)$(i,a,{get:t[a],enumerable:!0})},J=(i,t,a,p)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of X(t))!j.call(i,l)&&l!==a&&$(i,l,{get:()=>t[l],enumerable:!(p=Q(t,l))||p.enumerable});return i};var ee=i=>J($({},"__esModule",{value:!0}),i);var ae={};H(ae,{default:()=>D});module.exports=ee(ae);var s=require("@raycast/api"),E=require("child_process"),m=require("react");var te=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],ie=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],se=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],re=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],k=(i,t,a)=>{let p=i;return typeof t=="string"||Array.isArray(t)?p=i.toLocaleString(t,a):(t===!0||a!==void 0)&&(p=i.toLocaleString(void 0,a)),p};function T(i,t){if(!Number.isFinite(i))throw new TypeError(`Expected a finite number, got ${typeof i}: ${i}`);t={bits:!1,binary:!1,space:!0,...t};let a=t.bits?t.binary?re:se:t.binary?ie:te,p=t.space?" ":"";if(t.signed&&i===0)return` 0${p}${a[0]}`;let l=i<0,y=l?"-":t.signed?"+":"";l&&(i=-i);let d;if(t.minimumFractionDigits!==void 0&&(d={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(d={maximumFractionDigits:t.maximumFractionDigits,...d}),i<1){let x=k(i,t.locale,d);return y+x+p+a[0]}let I=Math.min(Math.floor(t.binary?Math.log(i)/Math.log(1024):Math.log10(i)/3),a.length-1);i/=(t.binary?1024:1e3)**I,d||(i=i.toPrecision(3));let w=k(Number(i),t.locale,d),M=a[I];return y+w+p+M}var S=require("react"),ne=()=>{};function oe(i,t){let a=(0,S.useRef)(ne);(0,S.useEffect)(()=>{a.current=i},[i]),(0,S.useEffect)(()=>{if(a.current(),(t??0)>0){let l=Math.max(t??0,1e3),y=setInterval(()=>a.current(),l);return()=>clearInterval(y)}},[t])}var L=oe;var f=require("react/jsx-runtime");function D(){let[i,t]=(0,m.useState)([]),[a,p]=(0,m.useState)([]),[l,y]=(0,m.useState)(""),d=(0,s.getPreferenceValues)(),I=d.shouldSearchInPaths,w=d.shouldSearchInPid,M=d.shouldPrioritizeAppsWhenFiltering,x=d.shouldShowPID,R=d.shouldShowPath,v=+d.refreshDuration,K=d.closeWindowAfterKill,C=d.clearSearchBarAfterKill,U=d.goToRootAfterKill,[P,W]=(0,m.useState)(d.sortByMem),[N,Y]=(0,m.useState)(d.aggregateApps),F=()=>{(0,E.exec)("ps -eo pid,ppid,pcpu,rss,comm",(e,o)=>{if(e!=null)return;let c=o.split(`
`).map(g=>{let b=["","","","","",""],B=/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/,[,r,u,n,h,A]=g.match(B)??b,V=A.match(/[^/]*[^/]*$/i)?.[0]??"",q=A.includes(".prefPane"),O=A.includes(".app/");return{id:parseInt(r),pid:parseInt(u),cpu:parseFloat(n),mem:parseInt(h),type:q?"prefPane":O?"app":"binary",path:A,processName:V}}).filter(g=>g.processName!=="");t(c)})};L(F,v),(0,m.useEffect)(()=>{let e=i;N&&(e=z(e)),e.sort((o,c)=>P?o.mem>c.mem?-1:1:o.cpu>c.cpu?-1:1),p(e)},[i,P,N]);let G=e=>e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns",Z=e=>{(0,E.exec)(`kill -9 ${e.id}`),t(a.filter(o=>o.id!==e.id)),K&&(0,s.closeMainWindow)(),U&&(0,s.popToRoot)({clearSearchBar:C}),C&&(0,s.clearSearchBar)({forceScrollToTop:!0}),(0,s.showToast)({title:`\u2705 Killed ${e.processName==="-"?`process ${e.id}`:e.processName}`,style:s.Toast.Style.Success})},_=e=>{let o=[];return e.type==="aggregatedApp"&&e.appName!=null&&o.push(e.appName),x&&o.push(e.id.toString()),R&&o.push(e.path),o.join(" - ")},z=e=>{let o=Array(),c=new Map;c.set(1,{process:{id:1},childNodes:[]});let g=Array();e.forEach(r=>{if(r.type==="app"){g.push(r.id);let u=c.get(r.id);u==null?(u={process:r,childNodes:[]},c.set(r.id,u)):u.process=r;let n=c.get(r.pid);if(n==null)n={process:void 0,childNodes:[u]},c.set(r.pid,n);else if(n.process==null)n.childNodes.push(u);else{let h;for(;n?.process!=null&&n.process.pid!==1&&(h=c.get(n.process.pid))!=null;)n=h;n?.childNodes.push(u)}n.process?.id!==1&&(n.childNodes=n.childNodes.concat(u.childNodes),u.childNodes=[])}else o.push(r)});let b=c.get(1)?.childNodes,B=Array();return b?.forEach(r=>{if(r.process==null)return;B.push(r.process.id);let u=r.childNodes.map(n=>n.process?.id).filter(n=>n!=null);B=B.concat(u),o.push({id:r.process.id,pid:r.process.pid,cpu:(r.childNodes?.reduce((n,h)=>n+(h.process?.cpu??0),0)??0)+r.process.cpu,mem:(r.childNodes?.reduce((n,h)=>n+(h.process?.mem??0),0)??0)+r.process.mem,type:"aggregatedApp",path:r.process.path,processName:r.process.processName,appName:r.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),o};return(0,f.jsx)(s.List,{isLoading:a.length===0,searchBarPlaceholder:"Filter by name...",onSearchTextChange:e=>y(e),children:a.filter(e=>{if(l==="")return!0;let o=e.processName.toLowerCase().includes(l.toLowerCase()),c=I&&e.path.toLowerCase().match(new RegExp(`.+${l}.*\\.[app|framework|prefpane]`,"ig"))!=null,g=w&&e.id.toString().includes(l),b=e.type==="aggregatedApp"&&e.appName?.toLowerCase().includes(l.toLowerCase());return o||c||g||b}).sort((e,o)=>{if(M){let c=["app","aggregatedApp"];if(c.includes(e.type)&&!c.includes(o.type))return-1;if(!c.includes(e.type)&&c.includes(o.type))return 1}return 0}).map((e,o)=>{let c=G(e);return(0,f.jsx)(s.List.Item,{title:e.processName,subtitle:_(e),icon:c,accessories:[{text:P?`${e.cpu.toFixed(2)}% ${T(e.mem*1024)}`:`${T(e.mem*1024)} ${e.cpu.toFixed(2)}%`}],actions:(0,f.jsxs)(s.ActionPanel,{children:[(0,f.jsx)(s.Action,{title:"Kill",icon:s.Icon.XMarkCircle,onAction:()=>Z(e)}),e.path==null?null:(0,f.jsx)(s.Action.CopyToClipboard,{title:"Copy Path",content:e.path}),(0,f.jsx)(s.Action,{title:"Reload",icon:s.Icon.ArrowClockwise,shortcut:{key:"r",modifiers:["cmd"]},onAction:()=>F()}),(0,f.jsx)(s.Action,{title:`Sort by ${P?"CPU":"memory"} usage`,icon:s.Icon.Filter,shortcut:{key:"tab",modifiers:[]},onAction:()=>{W(!P),(0,s.showToast)({title:`Sorted by ${P?"CPU":"memory"} usage`})}}),(0,f.jsx)(s.Action,{title:`${N?"Dis":"En"}able aggregating apps`,icon:s.Icon.AppWindow,shortcut:{key:"tab",modifiers:["shift"]},onAction:()=>{Y(!N),(0,s.showToast)({title:`${N?"Dis":"En"}abled aggregating apps`})}})]})},o)})})}
